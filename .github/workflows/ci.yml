name: CI & CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  IMAGE: longtb11/mail-to-telegram
  TAG: ${{ github.sha }}

jobs:
  ci:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies (Next.js app)
        working-directory: gmail-viewer-app
        run: npm ci

      - name: Lint and build (Next.js app)
        working-directory: gmail-viewer-app
        run: |
          npm run lint
          npm run build

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        working-directory: mail-to-telegram
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Login Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
          
      - name: Run Python tests
        working-directory: mail-to-telegram
        run: |
          if [ -f tests ]; then pytest tests; fi

      - name: Build with env
        env:
          MYSQL_HOST: ${{ secrets.MYSQL_HOST }}
          MYSQL_USER: ${{ secrets.MYSQL_USER }}
          MYSQL_PASSWORD: ${{ secrets.MYSQL_PASSWORD }}
          MYSQL_DATABASE: ${{ secrets.MYSQL_DATABASE }}
          GMAIL_USER: ${{ secrets.GMAIL_USER }}
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
          ALLOWED_SENDER: ${{ secrets.ALLOWED_SENDER }}
          SLEEPTIME: ${{ secrets.SLEEPTIME }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
        run: docker compose build

      - name: Tag images
        env:
          TAG: ${{ github.sha }}
        run: |
          docker tag longtb11/gmail-viewer longtb11/gmail-viewer:$TAG
          docker tag longtb11/mail-to-telegram longtb11/mail-to-telegram:$TAG

      - name: Push images
        env:
          TAG: ${{ github.sha }}
        run: |
          docker push longtb11/gmail-viewer:$TAG
          docker push longtb11/mail-to-telegram:$TAG

  cd:
    needs: ci
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Deploy mail-to-telegram
        uses: appleboy/ssh-action@v1.0.0
        env:
          TAG: ${{ github.sha }}
          MYSQL_HOST: ${{ secrets.MYSQL_HOST }}
          MYSQL_USER: ${{ secrets.MYSQL_USER }}
          MYSQL_PASSWORD: ${{ secrets.MYSQL_PASSWORD }}
          MYSQL_DATABASE: ${{ secrets.MYSQL_DATABASE }}
          GMAIL_USER: ${{ secrets.GMAIL_USER }}
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
          ALLOWED_SENDER: ${{ secrets.ALLOWED_SENDER }}
          SLEEPTIME: ${{ secrets.SLEEPTIME }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          envs: >
            TAG,
            MYSQL_HOST,
            MYSQL_USER,
            MYSQL_PASSWORD,
            MYSQL_DATABASE,
            GMAIL_USER,
            GMAIL_APP_PASSWORD,
            TELEGRAM_TOKEN,
            CHAT_ID,
            ALLOWED_SENDER,
            SLEEPTIME,
            AWS_ACCESS_KEY_ID,
            AWS_SECRET_ACCESS_KEY,
            AWS_DEFAULT_REGION
          script: |
            docker pull longtb11/mail-to-telegram:$TAG
            docker stop mail-to-telegram || true
            docker rm mail-to-telegram || true
            docker run -d \
              --name mail-to-telegram \
              -e MYSQL_HOST="$MYSQL_HOST" \
              -e MYSQL_USER="$MYSQL_USER" \
              -e MYSQL_PASSWORD="$MYSQL_PASSWORD" \
              -e MYSQL_DATABASE="$MYSQL_DATABASE" \
              -e GMAIL_USER="$GMAIL_USER" \
              -e GMAIL_APP_PASSWORD="$GMAIL_APP_PASSWORD" \
              -e TELEGRAM_TOKEN="$TELEGRAM_TOKEN" \
              -e CHAT_ID="$CHAT_ID" \
              -e ALLOWED_SENDER="$ALLOWED_SENDER" \
              -e SLEEPTIME="$SLEEPTIME" \
              -e AWS_ACCESS_KEY_ID="$AWS_ACCESS_KEY_ID" \
              -e AWS_SECRET_ACCESS_KEY="$AWS_SECRET_ACCESS_KEY" \
              -e AWS_DEFAULT_REGION="$AWS_DEFAULT_REGION" \
              longtb11/mail-to-telegram:$TAG

              
      - name: Deploy gmail-viewer to server
        uses: appleboy/ssh-action@v1.0.0
        env:
          TAG: ${{ github.sha }}
          MYSQL_HOST: ${{ secrets.MYSQL_HOST }}
          MYSQL_USER: ${{ secrets.MYSQL_USER }}
          MYSQL_PASSWORD: ${{ secrets.MYSQL_PASSWORD }}
          MYSQL_DATABASE: ${{ secrets.MYSQL_DATABASE }}
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          envs: >
            TAG,
            MYSQL_HOST,
            MYSQL_USER,
            MYSQL_PASSWORD,
            MYSQL_DATABASE
          script: |
            docker pull longtb11/gmail-viewer:$TAG
            docker stop gmail-viewer || true
            docker rm gmail-viewer || true
            docker run -d \
              --name gmail-viewer \
              -e MYSQL_HOST="$MYSQL_HOST" \
              -e MYSQL_USER="$MYSQL_USER" \
              -e MYSQL_PASSWORD="$MYSQL_PASSWORD" \
              -e MYSQL_DATABASE="$MYSQL_DATABASE" \
              -p 80:80 \
              longtb11/gmail-viewer:$TAG