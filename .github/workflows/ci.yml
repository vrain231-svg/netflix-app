
name: CI & CD Pipeline

on:
  push:
    branches: [ main ]
    paths:
      - 'gmail-viewer-app/**'
      - 'mail-to-telegram/**'
      - 'docker/**'
      - '.github/workflows/ci.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'gmail-viewer-app/**'
      - 'mail-to-telegram/**'
      - 'docker/**'
      - '.github/workflows/ci.yml'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  IMAGE: longtb11/mail-to-telegram
  TAG: ${{ github.sha }}

jobs:
  ci:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1  # shallow clone for speed

      - name: Cache Node.js dependencies
        uses: actions/cache@v4
        with:
          path: gmail-viewer-app/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('gmail-viewer-app/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: Login Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build with env (with cache)
        # env:
        #   MYSQL_HOST: ${{ secrets.MYSQL_HOST }}
        #   MYSQL_USER: ${{ secrets.MYSQL_USER }}
        #   MYSQL_PASSWORD: ${{ secrets.MYSQL_PASSWORD }}
        #   MYSQL_DATABASE: ${{ secrets.MYSQL_DATABASE }}
        #   GMAIL_USER: ${{ secrets.GMAIL_USER }}
        #   GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
        #   TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
        #   CHAT_ID: ${{ secrets.CHAT_ID }}
        #   ALLOWED_SENDER: ${{ secrets.ALLOWED_SENDER }}
        #   SLEEPTIME: ${{ secrets.SLEEPTIME }}
        #   AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        #   AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        #   AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
        run: |
          docker compose build \
            --build-arg BUILDKIT_INLINE_CACHE=1

      - name: Tag images
        env:
          TAG: ${{ github.sha }}
        run: |
          docker tag longtb11/gmail-viewer longtb11/gmail-viewer:$TAG
          docker tag longtb11/mail-to-telegram longtb11/mail-to-telegram:$TAG
          docker tag longtb11/gmail-websocket longtb11/gmail-websocket:$TAG

      - name: Push images
        env:
          TAG: ${{ github.sha }}
        run: |
          docker push longtb11/gmail-viewer:$TAG
          docker push longtb11/mail-to-telegram:$TAG
          docker push longtb11/gmail-websocket:$TAG
  clean-up:
    needs: ci
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Cleanup Docker on server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            echo "Stopping containers..."
            docker stop gmail-viewer || true
            docker stop mail-to-telegram || true
            docker stop gmail-websocket || true

            echo "Removing containers..."
            docker rm gmail-viewer || true
            docker rm mail-to-telegram || true
            docker rm gmail-websocket || true

            echo "Docker prune..."
            docker system prune -af --volumes

  deploy_websocket:
    needs: clean-up
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Deploy websocket
        uses: appleboy/ssh-action@v1.0.0
        env:
          TAG: ${{ github.sha }}
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          envs: >
            TAG
          script: |
            docker pull longtb11/gmail-websocket:$TAG
            docker run -d \
              --name gmail-websocket \
              -p 3001:3001 \
              longtb11/gmail-websocket:$TAG

  deploy_mail_to_telegram:
    needs: clean-up
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Deploy mail-to-telegram
        uses: appleboy/ssh-action@v1.0.0
        env:
          TAG: ${{ github.sha }}
          MYSQL_HOST: ${{ secrets.MYSQL_HOST }}
          MYSQL_USER: ${{ secrets.MYSQL_USER }}
          MYSQL_PASSWORD: ${{ secrets.MYSQL_PASSWORD }}
          MYSQL_DATABASE: ${{ secrets.MYSQL_DATABASE }}
          GMAIL_USER: ${{ secrets.GMAIL_USER }}
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
          ALLOWED_SENDER: ${{ secrets.ALLOWED_SENDER }}
          SLEEPTIME: ${{ secrets.SLEEPTIME }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          envs: >
            TAG,
            MYSQL_HOST,
            MYSQL_USER,
            MYSQL_PASSWORD,
            MYSQL_DATABASE,
            GMAIL_USER,
            GMAIL_APP_PASSWORD,
            TELEGRAM_TOKEN,
            CHAT_ID,
            ALLOWED_SENDER,
            SLEEPTIME,
            AWS_ACCESS_KEY_ID,
            AWS_SECRET_ACCESS_KEY,
            AWS_DEFAULT_REGION
          script: |
            docker pull longtb11/mail-to-telegram:$TAG
            docker run -d \
              --name mail-to-telegram \
              -e MYSQL_HOST="$MYSQL_HOST" \
              -e MYSQL_USER="$MYSQL_USER" \
              -e MYSQL_PASSWORD="$MYSQL_PASSWORD" \
              -e MYSQL_DATABASE="$MYSQL_DATABASE" \
              -e GMAIL_USER="$GMAIL_USER" \
              -e GMAIL_APP_PASSWORD="$GMAIL_APP_PASSWORD" \
              -e TELEGRAM_TOKEN="$TELEGRAM_TOKEN" \
              -e CHAT_ID="$CHAT_ID" \
              -e ALLOWED_SENDER="$ALLOWED_SENDER" \
              -e SLEEPTIME="$SLEEPTIME" \
              -e AWS_ACCESS_KEY_ID="$AWS_ACCESS_KEY_ID" \
              -e AWS_SECRET_ACCESS_KEY="$AWS_SECRET_ACCESS_KEY" \
              -e AWS_DEFAULT_REGION="$AWS_DEFAULT_REGION" \
              longtb11/mail-to-telegram:$TAG

  deploy_gmail_viewer:
    needs: clean-up
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Deploy gmail-viewer to server
        uses: appleboy/ssh-action@v1.0.0
        env:
          TAG: ${{ github.sha }}
          MYSQL_HOST: ${{ secrets.MYSQL_HOST }}
          MYSQL_USER: ${{ secrets.MYSQL_USER }}
          MYSQL_PASSWORD: ${{ secrets.MYSQL_PASSWORD }}
          MYSQL_DATABASE: ${{ secrets.MYSQL_DATABASE }}
          NEXT_PUBLIC_SERVER_HOST: ${{ secrets.SERVER_HOST }}
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          envs: >
            TAG,
            MYSQL_HOST,
            MYSQL_USER,
            MYSQL_PASSWORD,
            MYSQL_DATABASE,
            NEXT_PUBLIC_SERVER_HOST
          script: |
            docker pull longtb11/gmail-viewer:$TAG
            docker run -d \
              --name gmail-viewer \
              -e MYSQL_HOST="$MYSQL_HOST" \
              -e MYSQL_USER="$MYSQL_USER" \
              -e MYSQL_PASSWORD="$MYSQL_PASSWORD" \
              -e MYSQL_DATABASE="$MYSQL_DATABASE" \
              -p 80:80 \
              longtb11/gmail-viewer:$TAG